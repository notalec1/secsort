<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Line Up! Ultimate</title>
    
    <!-- Modern Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #020617;
            --bg-glass: rgba(15, 23, 42, 0.6);
            --bg-glass-strong: rgba(15, 23, 42, 0.85);
            --bg-item: rgba(255, 255, 255, 0.03);
            --bg-item-hover: rgba(255, 255, 255, 0.08);
            
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --accent: #d946ef;
            --success: #10b981;
            --danger: #f43f5e;
            --gold: #eab308;
            
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            
            --border: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(255, 255, 255, 0.15);
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --font-main: 'Outfit', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            background: var(--bg-deep);
            color: var(--text-main);
            display: flex; justify-content: center; align-items: center;
            overflow-x: hidden;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior: none; 
        }

        /* --- BACKGROUNDS --- */
        #bgCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
            background: radial-gradient(circle at 50% 10%, #1e1b4b, #0f172a 60%, #020617);
        }
        #snowCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; opacity: 0.3; mix-blend-mode: overlay;
        }
        #redOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 2; transition: opacity 1s linear; opacity: 0;
            background: radial-gradient(circle, transparent 40%, rgba(220, 20, 60, 0.4) 100%);
        }

        /* --- APP CONTAINER --- */
        .app-card {
            width: 100%; max-width: 480px; 
            min-height: 100vh; /* Full screen on mobile */
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            position: relative; z-index: 10;
            display: flex; flex-direction: column;
            padding: 20px 24px 40px 24px;
            box-shadow: var(--shadow-glass);
            transition: all 0.4s ease;
        }

        @media (min-width: 768px) {
            .app-card {
                min-height: auto;
                border-radius: var(--radius-lg);
                border: 1px solid var(--border);
                margin: 40px;
                height: auto;
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* --- TV MODE LAYOUT --- */
        body.is-tv-mode .app-card {
            max-width: 96vw; width: 96vw; height: 92vh; margin: 0;
            display: grid; 
            grid-template-columns: 1fr 1.5fr; 
            gap: 30px;
            padding: 40px;
            background: var(--bg-glass-strong);
            overflow: hidden;
        }
        
        .tv-panel-left { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .tv-panel-right { display: flex; flex-direction: column; gap: 20px; height: 100%; overflow: hidden; }

        .glass-panel {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* --- TYPOGRAPHY --- */
        h1 { 
            font-size: 2.5rem; margin: 0 0 5px 0; font-weight: 900; letter-spacing: -1px; text-align: center;
            background: linear-gradient(135deg, #fff 30%, var(--primary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        h2 { font-size: 1.5rem; margin: 0 0 15px 0; font-weight: 700; text-align: center; color: var(--text-main); }
        h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-sub); margin-bottom: 15px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        h3::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        p { color: var(--text-sub); text-align: center; margin-bottom: 25px; font-weight: 300; }
        
        /* --- FORMS & INPUTS --- */
        .input-group { position: relative; margin-bottom: 15px; }
        .label-text { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin-bottom: 6px; display: block; letter-spacing: 1px; }
        
        input, select {
            width: 100%; padding: 16px; 
            background: var(--bg-item); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-sm);
            color: white; font-family: var(--font-main); font-size: 1rem; font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input:focus, select:focus { 
            outline: none; 
            background: rgba(255,255,255,0.05); 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }

        /* --- BUTTONS --- */
        button {
            width: 100%; padding: 16px; border: none; border-radius: var(--radius-sm);
            font-family: var(--font-main); font-size: 1rem; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        button:active { transform: scale(0.96); }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-glow) 100%);
            color: white; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover { filter: brightness(1.2); box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5); }
        .btn-primary:disabled { background: var(--border); color: var(--text-sub); box-shadow: none; cursor: not-allowed; }

        .btn-secondary { background: var(--bg-item); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-item-hover); border-color: var(--border-glow); }
        
        .btn-danger { background: rgba(244, 63, 94, 0.1); color: var(--danger); border: 1px solid rgba(244, 63, 94, 0.2); }
        .btn-danger:hover { background: rgba(244, 63, 94, 0.2); }

        .btn-icon { width: 42px; height: 42px; padding: 0; flex-shrink: 0; border-radius: 50%; }
        .btn-sm { padding: 8px 16px; font-size: 0.8rem; border-radius: 50px; width: auto; }

        /* --- LIST ITEMS & CARDS --- */
        .list-wrap { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; padding: 4px; }
        
        .item-card {
            background: var(--bg-item); 
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: flex; align-items: center; justify-content: space-between;
            transition: transform 0.2s, background 0.2s;
            animation: fadeIn 0.3s ease forwards;
        }
        .item-card:hover { background: var(--bg-item-hover); border-color: var(--border-glow); }
        
        .avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border); margin-right: 12px; background: #000; object-fit: cover; }
        
        /* Drag & Drop Specifics */
        .sortable-ghost { opacity: 0.2; background: var(--primary); }
        .sortable-drag { background: var(--bg-glass-strong); border: 1px solid var(--primary); transform: scale(1.02); box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 999; }
        .grab-handle { 
            cursor: grab; padding: 10px; color: var(--text-sub); font-size: 1.2rem;
            touch-action: none; /* CRITICAL FOR TOUCH DRAG */
        }

        /* --- CHIPS & TAGS --- */
        .chip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; margin: 15px 0; }
        .chip {
            background: var(--bg-item); border: 1px solid var(--border);
            padding: 8px; border-radius: var(--radius-sm);
            font-size: 0.8rem; font-weight: 600; color: var(--text-sub);
            cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .chip:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .chip.disabled { opacity: 0.3; pointer-events: none; text-decoration: line-through; }

        /* --- GAME ELEMENTS --- */
        .timer-float {
            font-family: 'Courier New', monospace; font-weight: 900; font-size: 2rem;
            color: var(--text-main); text-shadow: 0 0 20px var(--primary);
            text-align: center; margin: 10px 0;
        }
        
        .secret-box {
            position: relative; height: 180px; margin: 20px 0;
            background: black; border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; cursor: pointer;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        .secret-text { font-size: 6rem; font-weight: 900; color: white; opacity: 0; filter: blur(20px); transition: all 0.2s; z-index: 2; }
        .secret-overlay { position: absolute; z-index: 3; font-weight: 700; letter-spacing: 2px; color: var(--text-sub); pointer-events: none; transition: opacity 0.2s; }
        .secret-box.revealed .secret-text { opacity: 1; filter: blur(0); text-shadow: 0 0 30px var(--primary); }
        .secret-box.revealed .secret-overlay { opacity: 0; }
        /* Matrix Rain effect for secret box background */
        .secret-box::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(99, 102, 241, 0.1) 4px);
            z-index: 1; opacity: 0.5;
        }

        /* --- HEADER ACTIONS --- */
        .header-bar {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; z-index: 50;
            pointer-events: none; /* Let clicks pass through to content if needed */
        }
        .header-actions { pointer-events: auto; display: flex; gap: 8px; }
        .icon-btn { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            width: 36px; height: 36px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; cursor: pointer; color: var(--text-sub); transition: all 0.2s;
        }
        .icon-btn:hover { background: var(--bg-item-hover); color: white; transform: scale(1.1); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-card {
            background: var(--bg-deep); border: 1px solid var(--border);
            width: 90%; max-width: 400px; padding: 30px; border-radius: var(--radius-lg);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        /* --- UTILS --- */
        .row { display: flex; gap: 12px; }
        .col { flex: 1; }
        .divider { height: 1px; background: var(--border); margin: 20px 0; width: 100%; }
        .toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: white; color: black; padding: 10px 20px; border-radius: 50px;
            font-weight: 700; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 2000;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Grid for TV QR */
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .qr-card { background: white; padding: 10px; border-radius: var(--radius-sm); display: flex; flex-direction: column; align-items: center; }

        /* Mode Select Buttons */
        .mode-select-btn {
            height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
            background: linear-gradient(180deg, var(--bg-item) 0%, rgba(0,0,0,0) 100%);
            border: 1px solid var(--border);
        }
        .mode-select-btn:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .big-icon { font-size: 3rem; margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
    </style>
</head>
<body>

    <!-- Background Layers -->
    <div id="bgCanvas"></div>
    <div id="redOverlay"></div>
    <canvas id="snowCanvas"></canvas>
    
    <!-- Audio -->
    <audio id="lobbyMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112762.mp3" type="audio/mpeg">
    </audio>

    <!-- Header UI (Absolute) -->
    <div class="header-bar">
        <div class="header-actions">
            <!-- Left Side Actions -->
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="resetViewMode()" title="Switch View">‚ÜîÔ∏è</button>
            <button class="icon-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
            <button class="icon-btn" id="musicBtn" onclick="toggleMusic()" title="Sound">üîá</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-card">
        <!-- Content Injected via JS -->
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
            <h1>Line Up!</h1>
            <p>Loading...</p>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="qrModal" onclick="closeModal('qrModal')">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h2 id="qrName">Player</h2>
            <div id="qrDisplay" style="background:white; padding:15px; border-radius:12px; margin:20px auto; width:fit-content;"></div>
            <button class="btn-secondary" onclick="closeModal('qrModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="leaderboardModal" onclick="closeModal('leaderboardModal')">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h2>üèÜ Leaderboard</h2>
            <div id="mobileLeaderboardList" class="list-wrap" style="max-height:300px;"></div>
            <button class="btn-secondary" style="margin-top:20px;" onclick="closeModal('leaderboardModal')">Close</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="roomQrModal" onclick="closeModal('roomQrModal')">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h2>üè† Join Room</h2>
            <p>Scan to pick your name</p>
            <div id="roomQrDisplay" style="background:white; padding:15px; border-radius:12px; margin:20px auto; width:fit-content;"></div>
            <button class="btn-secondary" onclick="closeModal('roomQrModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="qrGridModal" onclick="closeModal('qrGridModal')">
        <div class="modal-card" style="max-width:800px; width:95%; height:90vh; overflow:hidden; display:flex; flex-direction:column;" onclick="event.stopPropagation()">
            <h2>Scan Your Code</h2>
            <div id="qrGridTarget" class="qr-grid" style="overflow-y:auto; padding:10px; flex:1;"></div>
            <button class="btn-secondary" style="margin-top:10px;" onclick="closeModal('qrGridModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="presetsModal" onclick="closeModal('presetsModal')">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h2>üíæ Saved Groups</h2>
            <div id="presetsList" class="list-wrap" style="max-height:300px;"></div>
            <button class="btn-secondary" style="margin-top:20px;" onclick="closeModal('presetsModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="dataModal" onclick="closeModal('dataModal')">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h2>‚öôÔ∏è Settings</h2>
            <div class="row">
                <button class="btn-secondary col" onclick="exportData()">üì§ Export</button>
                <button class="btn-secondary col" onclick="document.getElementById('fileInput').click()">üì• Import</button>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
            <div class="divider"></div>
            <button class="btn-danger" style="margin-bottom:10px;" onclick="resetScores()">üßπ Reset Scores</button>
            <button class="btn-danger" onclick="wipeData()">üóëÔ∏è Factory Reset</button>
            <button class="btn-secondary" style="margin-top:20px;" onclick="closeModal('dataModal')">Close</button>
        </div>
    </div>

    <!-- Feedback -->
    <div id="toast" class="toast">Message</div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const GOD_PASSWORD = "line1up";
        const AUTO_NAMES = ["Alec", "Alain", "Nada", "Hoda", "Fadi", "Noa", "Gio", "Neo", "Nounou", "Assaad", "Chris", "Eliott"];
        const DEFAULT_STATE = { 
            step: 'SETUP', 
            players: [], 
            settings: { min: 1, max: 100, order: 'asc' }, 
            startTime: null, 
            finalTime: null, 
            passIndex: 0, 
            viewingNumber: false 
        };
        
        // --- STATE ---
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let timerInterval = null;
        let godMode = false;
        let viewMode = sessionStorage.getItem('lineUpViewMode') || null; 
        let isMusicPlaying = false;
        
        // --- DOM ---
        const app = document.getElementById('app');
        const audioEl = document.getElementById('lobbyMusic');

        // --- UTILS ---
        function pulse(ms = 10) { if (navigator.vibrate) navigator.vibrate(ms); }
        async function requestWakeLock() { if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) {} } }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        function formatTime(s) { if(s === null) return "0:00"; return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; }
        function getAvatar(name) { return `https://api.dicebear.com/7.x/initials/svg?seed=${name}&backgroundColor=1e293b&textColor=f8fafc`; }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e=>{}); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
        
        function toggleMusic() {
            if(isMusicPlaying) { audioEl.pause(); isMusicPlaying = false; }
            else { audioEl.volume = 0.3; audioEl.play().catch(e=>showToast("Audio Blocked")); isMusicPlaying = true; }
            document.getElementById('musicBtn').innerText = isMusicPlaying ? 'üîä' : 'üîá';
        }

        // --- SNOW FX (Subtle) ---
        function initSnow() {
            const canvas = document.getElementById('snowCanvas');
            const ctx = canvas.getContext('2d');
            let w = canvas.width = window.innerWidth, h = canvas.height = window.innerHeight;
            const flakes = Array.from({length: 40}, () => ({x: Math.random()*w, y: Math.random()*h, r: Math.random()*2+1, d: Math.random()*50}));
            window.onresize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
            function loop() {
                ctx.clearRect(0,0,w,h); ctx.fillStyle = "rgba(255,255,255,0.6)"; ctx.beginPath();
                flakes.forEach(f => { ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=Math.pow(f.d,2)/2000+0.5; if(f.y>h)f.y=0; f.x+=Math.sin(f.y/50)*0.2; });
                ctx.fill(); requestAnimationFrame(loop);
            }
            loop();
        }

        // --- CORE LOGIC ---
        function loadState() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('p') || params.has('room')) return;
            try {
                const s = localStorage.getItem('lineUpState');
                if (s) {
                    state = JSON.parse(s);
                    if ((state.step === 'DISTRIBUTE' || state.step === 'VERIFY') && state.startTime) startTimerTicker();
                }
            } catch (e) { state = JSON.parse(JSON.stringify(DEFAULT_STATE)); }
        }
        function saveState() { if (!new URLSearchParams(window.location.search).has('p')) localStorage.setItem('lineUpState', JSON.stringify(state)); }
        function setState(s) { state.step = s; saveState(); render(); }
        
        function setViewMode(m) {
            viewMode = m; sessionStorage.setItem('lineUpViewMode', m);
            document.body.classList.toggle('is-tv-mode', m === 'tv');
            render();
        }
        function resetViewMode() { setViewMode(null); }

        function generateNumbers() {
            const min = parseInt(state.settings.min), max = parseInt(state.settings.max);
            if (min >= max) { showToast("Min must be < Max"); return false; }
            const used = new Set();
            state.players.forEach(p => {
                let num; do { num = Math.floor(Math.random()*(max-min+1))+min; } while(used.has(num));
                used.add(num); p.number = num;
            });
            return true;
        }

        // --- RENDERERS ---
        function render() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('p')) return renderPlayer(params.get('p'));
            if (params.get('room')) return renderRoom(params.get('room'));

            if (!viewMode) return renderModeSelect();

            const isTV = viewMode === 'tv';
            let content = '';

            // STATE DISPATCHER
            switch(state.step) {
                case 'SETUP': content = renderSetup(isTV); break;
                case 'DISTRIBUTE': content = renderDistribute(isTV); break;
                case 'PASS_PLAY': content = renderPassPlay(); break;
                case 'VERIFY': content = renderVerify(isTV); break;
                case 'RESULTS': content = renderResults(isTV); break;
            }

            // TV WRAPPER
            if (isTV) {
                // Split logic handles inside specific render functions for TV
                app.innerHTML = content;
            } else {
                app.innerHTML = content;
            }
        }

        // --- COMPONENT TEMPLATES ---
        function renderModeSelect() {
            app.innerHTML = `
                <h1>Welcome</h1>
                <p>Select your role</p>
                <div class="row" style="margin-top:20px;">
                    <button class="mode-select-btn col" onclick="setViewMode('mobile')">
                        <div class="big-icon">üì±</div>
                        Host / Play
                    </button>
                    <button class="mode-select-btn col" onclick="setViewMode('tv')">
                        <div class="big-icon">üì∫</div>
                        TV Display
                    </button>
                </div>
            `;
        }

        function renderSetup(isTV) {
            const pList = state.players.map((p,i) => `
                <div class="item-card">
                    <div style="display:flex; align-items:center;">
                        <img src="${getAvatar(p.name)}" class="avatar">
                        <strong>${p.name}</strong>
                    </div>
                    <button class="btn-danger btn-icon" style="width:32px; height:32px;" onclick="remPlayer(${i})">‚úï</button>
                </div>`).join('') || '<div style="text-align:center; opacity:0.5; padding:20px;">No players yet</div>';

            const chips = AUTO_NAMES.map(n => {
                const has = state.players.some(p=>p.name.toLowerCase()===n.toLowerCase());
                return `<div class="chip ${has?'disabled':''}" onclick="addPlayer('${n}')">${n}</div>`;
            }).join('');

            const form = `
                <div class="row">
                    <div class="col">
                        <div class="input-group">
                            <span class="label-text">Min Range</span>
                            <input type="number" id="minIn" value="${state.settings.min}" onchange="state.settings.min=this.value">
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group">
                            <span class="label-text">Max Range</span>
                            <input type="number" id="maxIn" value="${state.settings.max}" onchange="state.settings.max=this.value">
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <span class="label-text">Sorting Order</span>
                    <select onchange="state.settings.order=this.value">
                        <option value="asc" ${state.settings.order=='asc'?'selected':''}>Lowest to Highest (1 ‚ûî 100)</option>
                        <option value="desc" ${state.settings.order=='desc'?'selected':''}>Highest to Lowest (100 ‚ûî 1)</option>
                    </select>
                </div>
                
                <div class="divider"></div>
                
                <div class="row">
                    <input type="text" id="nameIn" placeholder="Enter player name" onkeydown="if(event.key==='Enter') addPlayer()">
                    <button class="btn-primary" style="width:auto" onclick="addPlayer()">Add</button>
                </div>
                <div class="chip-grid">${chips}</div>
                
                <div class="row" style="margin-top:20px; gap:8px;">
                    <button class="btn-secondary col" onclick="openModal('presetsModal')">üíæ Groups</button>
                    <button class="btn-secondary col" onclick="openModal('leaderboardModal')">üèÜ Rank</button>
                    <button class="btn-secondary col" onclick="openModal('dataModal')">‚öôÔ∏è Data</button>
                </div>
            `;

            const actions = `
                <button class="btn-primary" style="margin-top:20px;" onclick="startMain()" ${state.players.length<2?'disabled':''}>
                    GENERATE & PLAY üöÄ
                </button>
                ${!isTV ? `<div style="text-align:center; margin:10px; opacity:0.5; font-size:0.8rem;">OR</div>
                <button class="btn-secondary" onclick="startPass()" ${state.players.length<2?'disabled':''}>üì± Pass & Play Mode</button>` : ''}
            `;

            if(isTV) {
                return `<div class="tv-panel-left">
                            <h1>Setup Game</h1>
                            ${form}
                            ${actions}
                        </div>
                        <div class="tv-panel-right">
                            <h3>Roster (${state.players.length})</h3>
                            <div class="glass-panel list-wrap">${pList}</div>
                        </div>`;
            }
            return `<h1>Line Up!</h1><p>Setup Game</p>${form}<div class="divider"></div><h3>Roster (${state.players.length})</h3><div class="list-wrap">${pList}</div>${actions}`;
        }

        function renderDistribute(isTV) {
            const time = `<div class="timer-float" id="timerDisplay">Waiting...</div>`;
            const base = window.location.href.split('?')[0];
            
            const links = state.players.map(p => {
                const d = btoa(JSON.stringify({n:p.name, v:p.number, min:state.settings.min, max:state.settings.max}));
                const url = `${base}?p=${d}`;
                return `
                <div class="item-card">
                    <div style="display:flex; align-items:center;">
                        <img src="${getAvatar(p.name)}" class="avatar">
                        <strong>${p.name}</strong>
                    </div>
                    <div class="row" style="gap:5px;">
                        <button class="btn-secondary btn-icon" onclick="showQr('${url}','${p.name}')">üèÅ</button>
                        <button class="btn-secondary btn-icon" onclick="share('${url}','${p.name}')">üîó</button>
                    </div>
                </div>`;
            }).join('');

            const controls = `
                ${time}
                <p>Send links to players so they get their numbers.</p>
                <button class="btn-primary" onclick="setState('VERIFY')">Start Verification</button>
                <div class="row" style="margin-top:10px;">
                    <button class="btn-secondary col" onclick="openRoomQr()">üè† Room QR</button>
                    ${isTV ? `<button class="btn-secondary col" onclick="openGridQr()">üì∫ All QRs</button>`:''}
                </div>
                <button class="btn-danger btn-sm" style="margin-top:20px; background:transparent; border:none;" onclick="setState('SETUP')">Back to Setup</button>
            `;

            if(isTV) {
                return `<div class="tv-panel-left">${controls}</div>
                        <div class="tv-panel-right"><h3>Players</h3><div class="glass-panel list-wrap">${links}</div></div>`;
            }
            return `<h2>üîó Distribute</h2>${controls}<div class="divider"></div><div class="list-wrap">${links}</div>`;
        }

        function renderPassPlay() {
            const p = state.players[state.passIndex];
            if(!state.viewingNumber) {
                return `<div style="text-align:center; margin-top:40px;">
                            <div style="font-size:4rem; margin-bottom:20px;">üôà</div>
                            <h2>Pass Device to</h2>
                            <h1 style="font-size:3.5rem; color:var(--accent);">${p.name}</h1>
                            <div class="divider"></div>
                            <button class="btn-primary" onclick="state.viewingNumber=true;saveState();render()">I am ${p.name}</button>
                        </div>`;
            }
            return `<div style="text-align:center;">
                        <h2>Hi, ${p.name}</h2>
                        <p>Tap & Hold to see your number</p>
                        <div id="secretBox" class="secret-box">
                            <div class="secret-overlay">HOLD TO REVEAL</div>
                            <div class="secret-text" id="secretNum">${p.number}</div>
                        </div>
                        <p>Range: ${state.settings.min} - ${state.settings.max}</p>
                        <button class="btn-primary" onclick="nextPass()">${state.passIndex<state.players.length-1?'Next Player':'Finish'}</button>
                    </div>`;
        }

        function renderVerify(isTV) {
            // Important: Add Sortable after render
            setTimeout(initSortable, 100);
            
            const time = `<div class="timer-float" id="timerDisplay">0:00</div>`;
            const list = state.players.map((p,i) => `
                <div class="item-card" data-idx="${i}">
                    <div style="display:flex; align-items:center;">
                        <div class="grab-handle">‚ò∞</div>
                        <div style="background:var(--text-main); color:var(--bg-deep); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px; font-size:0.8rem;">${i+1}</div>
                        <img src="${getAvatar(p.name)}" class="avatar">
                        <strong>${p.name}</strong>
                        ${godMode ? `<span style="color:var(--accent); margin-left:5px;">(${p.number})</span>`:''}
                    </div>
                </div>`).join('');

            const actions = `
                ${time}
                <div class="row" style="margin: 10px 0;">
                    <button class="btn-secondary" onclick="toggleGod()">${godMode?'üîì Admin':'üîí Admin'}</button>
                </div>
                <button class="btn-primary" style="background:linear-gradient(135deg, var(--success), #059669);" onclick="checkOrder()">REVEAL RESULT</button>
            `;

            if(isTV) {
                return `<div class="tv-panel-left"><h1>Verify Order</h1><p>Drag players to sort them.</p>${actions}</div>
                        <div class="tv-panel-right"><h3>Current Line Up</h3><div class="glass-panel list-wrap" id="sortList">${list}</div></div>`;
            }
            return `<h2>üßê Verify</h2>${time}<div class="list-wrap" id="sortList">${list}</div><div class="divider"></div>${actions}`;
        }

        function renderResults(isTV) {
            clearInterval(timerInterval);
            const sorted = [...state.players].sort((a,b) => state.settings.order=='asc' ? a.number-b.number : b.number-a.number);
            let perfect = true;
            
            // Calc MVP (Closest to ideal position)
            let mvp = null, minDelta = Infinity;
            state.players.forEach((p,i) => {
                if(p.name !== sorted[i].name) perfect = false;
                const ideal = (p.number - state.settings.min)/(state.settings.max-state.settings.min) * (state.players.length-1);
                const delta = Math.abs(i - ideal);
                if(delta < minDelta) { minDelta = delta; mvp = p.name; }
            });

            if(perfect && !state.finalTime) {
                state.finalTime = Math.floor((Date.now()-state.startTime)/1000);
                saveState();
                confetti({particleCount:150, spread:100});
                updateScores();
            } else if(!state.finalTime) {
                state.finalTime = Math.floor((Date.now()-state.startTime)/1000);
                saveState();
                updateScores();
            }

            const resList = state.players.map((p,i) => {
                const ok = p.name === sorted[i].name;
                const isMvp = p.name === mvp;
                return `
                <div class="item-card" style="border-color:${ok? 'var(--success)':'var(--danger)'}; background:${ok?'rgba(16, 185, 129, 0.1)':'rgba(244, 63, 94, 0.1)'}">
                    <div>
                        <div style="display:flex; align-items:center;">
                            <strong style="margin-right:10px;">${i+1}.</strong>
                            <img src="${getAvatar(p.name)}" class="avatar">
                            <strong>${p.name}</strong>
                            ${isMvp ? '<span style="font-size:0.7rem; background:var(--gold); color:black; padding:2px 6px; border-radius:4px; margin-left:8px;">MVP</span>':''}
                        </div>
                        <div style="font-size:0.8rem; margin-left:45px; opacity:0.8;">Held: <strong>${p.number}</strong></div>
                    </div>
                    <div style="font-size:1.5rem;">${ok?'‚úÖ':'‚ùå'}</div>
                </div>`;
            }).join('');

            const header = `
                <div class="timer-float" style="color:var(--gold)">${formatTime(state.finalTime)}</div>
                <h1>${perfect?'PERFECT! üéâ':'SO CLOSE... üò¨'}</h1>
                <div class="row" style="margin-top:20px;">
                    <button class="btn-primary col" onclick="restart()">üîÑ Replay</button>
                    <button class="btn-secondary col" onclick="resetGame()">New Game</button>
                </div>
            `;

            if(isTV) {
                return `<div class="tv-panel-left" style="justify-content:center;">${header}</div>
                        <div class="tv-panel-right"><h3>Results</h3><div class="glass-panel list-wrap">${resList}</div></div>`;
            }
            return `${header}<div class="divider"></div><div class="list-wrap">${resList}</div>`;
        }

        // --- PLAYER & ROOM RENDERERS ---
        function renderPlayer(encoded) {
            try {
                const d = JSON.parse(atob(encoded));
                app.innerHTML = `
                    <div style="text-align:center;">
                        <img src="${getAvatar(d.n)}" style="width:60px; height:60px; border-radius:50%; margin-bottom:10px; border:2px solid var(--border);">
                        <h2>${d.n}</h2>
                        <div id="secretBox" class="secret-box">
                            <div class="secret-overlay">HOLD TO REVEAL</div>
                            <div class="secret-text" id="secretNum">${d.v}</div>
                        </div>
                        <p>Range: ${d.min} - ${d.max}</p>
                    </div>`;
                bindSecret();
            } catch(e) { app.innerHTML = `<h2>Error</h2><p>Invalid Link</p>`; }
        }

        function renderRoom(encoded) {
            try {
                const d = JSON.parse(atob(encoded));
                const list = d.players.map(p => {
                    const payload = btoa(JSON.stringify({n:p.n, v:p.v, min:d.min, max:d.max}));
                    return `<button class="btn-secondary" style="justify-content:space-between; margin-bottom:10px;" onclick="window.location.search='?p=${payload}'">
                        <div style="display:flex; align-items:center;"><img src="${getAvatar(p.n)}" class="avatar"><b>${p.n}</b></div>üëâ
                    </button>`;
                }).join('');
                app.innerHTML = `<h2>Select Name</h2><div class="list-wrap">${list}</div>`;
            } catch(e) { app.innerHTML = `<h2>Error</h2>`; }
        }

        // --- ACTIONS ---
        function addPlayer(n) {
            const name = n || document.getElementById('nameIn').value.trim();
            if(!name || state.players.some(p=>p.name.toLowerCase()===name.toLowerCase())) return showToast("Invalid/Duplicate");
            state.players.push({name, number:0});
            if(document.getElementById('nameIn')) document.getElementById('nameIn').value='';
            setState('SETUP'); pulse();
        }
        function remPlayer(i) { state.players.splice(i,1); setState('SETUP'); pulse(); }
        function startMain() { if(generateNumbers()) { state.startTime=Date.now(); state.finalTime=null; setState('DISTRIBUTE'); requestWakeLock(); } }
        function startPass() { if(generateNumbers()) { state.passIndex=0; state.viewingNumber=false; state.startTime=null; setState('PASS_PLAY'); requestWakeLock(); } }
        function nextPass() { 
            if(state.passIndex < state.players.length-1) { state.passIndex++; state.viewingNumber=false; saveState(); render(); }
            else { state.startTime=Date.now(); setState('VERIFY'); }
        }
        function checkOrder() { setState('RESULTS'); }
        function restart() { state.startTime=null; state.finalTime=null; startMain(); }
        function resetGame() { state = JSON.parse(JSON.stringify(DEFAULT_STATE)); saveState(); render(); }
        function toggleGod() { 
            if(godMode) godMode=false; 
            else if(prompt("Pass:")===GOD_PASSWORD) { godMode=true; showToast("Admin On"); }
            render();
        }

        // --- SORTABLE (DRAG FIX) ---
        function initSortable() {
            const el = document.getElementById('sortList');
            if(!el) return;
            new Sortable(el, {
                animation: 200,
                handle: '.grab-handle', // Must drag by handle
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                forceFallback: true, // FIX FOR TV/TOUCH
                fallbackClass: 'sortable-drag',
                onEnd: (evt) => {
                    const item = state.players.splice(evt.oldIndex, 1)[0];
                    state.players.splice(evt.newIndex, 0, item);
                    saveState();
                    renderVerify(viewMode === 'tv'); // Re-render to update index numbers
                }
            });
        }

        // --- SECRET BOX INTERACTION ---
        function bindSecret() {
            const box = document.getElementById('secretBox');
            const num = document.getElementById('secretNum');
            if(!box) return;
            const target = num.innerText;
            let interval;
            
            const start = (e) => {
                if(e.cancelable) e.preventDefault();
                box.classList.add('revealed'); pulse();
                let i=0; clearInterval(interval);
                interval = setInterval(() => {
                    num.innerText = Math.floor(Math.random()*100);
                    if(++i > 8) { clearInterval(interval); num.innerText = target; }
                }, 40);
            };
            const stop = (e) => { box.classList.remove('revealed'); clearInterval(interval); num.innerText=target; };
            
            ['mousedown','touchstart'].forEach(e=>box.addEventListener(e,start,{passive:false}));
            ['mouseup','mouseleave','touchend'].forEach(e=>box.addEventListener(e,stop));
        }

        // --- TIMERS & BG ---
        function startTimerTicker() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const el = document.getElementById('timerDisplay');
                if(el && state.startTime && !state.finalTime) {
                    const diff = (Date.now() - state.startTime)/1000;
                    el.innerText = formatTime(Math.floor(diff));
                    // Red Overlay Logic
                    const intensity = Math.min(diff / 300, 0.8); // Max red at 5 mins
                    document.getElementById('redOverlay').style.opacity = intensity;
                }
            }, 1000);
        }

        // --- MODALS & QR ---
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            if(id==='leaderboardModal') {
                const s = JSON.parse(localStorage.getItem('lineUpLeaderboard')||'{}');
                const h = Object.entries(s).sort((a,b)=>b[1]-a[1]).map((e,i)=>`
                    <div class="item-card"><div style="display:flex;align-items:center;"><b>${i+1}.</b><span style="margin-left:10px">${e[0]}</span></div><b>${e[1]} pts</b></div>
                `).join('');
                document.getElementById('mobileLeaderboardList').innerHTML = h || '<p>No scores yet</p>';
            }
            if(id==='presetsModal') {
                const p = JSON.parse(localStorage.getItem('lineUpPresets')||'[]');
                document.getElementById('presetsList').innerHTML = p.map((g,i)=>`
                    <div class="item-card"><span>${g.name} (${g.players.length})</span><div class="row" style="gap:5px"><button class="btn-primary btn-sm" onclick="loadPreset(${i})">Load</button><button class="btn-danger btn-sm" onclick="delPreset(${i})">X</button></div></div>
                `).join('') || '<p>No presets</p>';
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showQr(url,n) {
            openModal('qrModal'); document.getElementById('qrName').innerText=n;
            const c=document.getElementById('qrDisplay'); c.innerHTML='';
            new QRCode(c,{text:url,width:200,height:200});
        }
        function openGridQr() {
            openModal('qrGridModal');
            const c=document.getElementById('qrGridTarget'); c.innerHTML='';
            const base = window.location.href.split('?')[0];
            state.players.forEach(p => {
                const d = btoa(JSON.stringify({n:p.name, v:p.number, min:state.settings.min, max:state.settings.max}));
                const dEl = document.createElement('div'); dEl.className='qr-card';
                dEl.innerHTML = `<b>${p.name}</b><div id="qg-${p.name}"></div>`;
                c.appendChild(dEl);
                new QRCode(document.getElementById(`qg-${p.name}`), {text:`${base}?p=${d}`, width:120, height:120});
            });
        }
        function openRoomQr() {
            openModal('roomQrModal');
            const c=document.getElementById('roomQrDisplay'); c.innerHTML='';
            const d = {players:state.players.map(p=>({n:p.name,v:p.number})), min:state.settings.min, max:state.settings.max};
            new QRCode(c,{text:`${window.location.href.split('?')[0]}?room=${btoa(JSON.stringify(d))}`, width:220, height:220});
        }
        async function share(url,n) { if(navigator.share) try{await navigator.share({title:'LineUp',text:n,url:url})}catch(e){} else {navigator.clipboard.writeText(url);showToast('Copied');} }

        // --- DATA ---
        function updateScores() {
            const s = JSON.parse(localStorage.getItem('lineUpLeaderboard')||'{}');
            const sorted = [...state.players].sort((a,b)=>state.settings.order=='asc'?a.number-b.number:b.number-a.number);
            let chg=false;
            state.players.forEach((p,i)=>{ if(p.name===sorted[i].name){s[p.name]=(s[p.name]||0)+10;chg=true;}else{s[p.name]=s[p.name]||0;} });
            if(chg) localStorage.setItem('lineUpLeaderboard',JSON.stringify(s));
        }
        function resetScores() { localStorage.removeItem('lineUpLeaderboard'); showToast('Reset'); closeModal('dataModal'); }
        function savePreset() {
            if(!state.players.length) return;
            const n=prompt('Group Name:'); if(!n) return;
            const p = JSON.parse(localStorage.getItem('lineUpPresets')||'[]');
            p.push({name:n, players:state.players, min:state.settings.min, max:state.settings.max});
            localStorage.setItem('lineUpPresets',JSON.stringify(p)); showToast('Saved');
        }
        function loadPreset(i) {
            const p = JSON.parse(localStorage.getItem('lineUpPresets')||'[]')[i];
            if(p){ state.players=p.players; state.settings.min=p.min; state.settings.max=p.max; saveState(); closeModal('presetsModal'); render(); }
        }
        function delPreset(i) {
            const p = JSON.parse(localStorage.getItem('lineUpPresets')||'[]'); p.splice(i,1);
            localStorage.setItem('lineUpPresets',JSON.stringify(p)); openModal('presetsModal');
        }
        function exportData() {
            const d = JSON.stringify(localStorage);
            const b = new Blob([d],{type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='lineup.json'; a.click();
        }
        function importData(e) {
            const r = new FileReader(); r.onload=ev=>{ 
                try{ const d=JSON.parse(ev.target.result); Object.keys(d).forEach(k=>localStorage.setItem(k,d[k])); location.reload(); }catch(x){} 
            }; r.readAsText(e.target.files[0]);
        }
        function wipeData() { if(confirm('Factory Reset?')) { localStorage.clear(); location.reload(); } }

        // --- BOOT ---
        initSnow();
        loadState();
        render();
    </script>
</body>
</html>