<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Up! Hybrid</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --success: #10b981; --danger: #ef4444; --gold: #f59e0b;
            --text-main: #1e293b; --text-sub: #64748b;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-item: rgba(255, 255, 255, 0.6);
            --border: rgba(255, 255, 255, 0.6);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --radius: 24px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --text-main: #f8fafc; --text-sub: #94a3b8;
                --bg-card: rgba(30, 41, 59, 0.85);
                --bg-item: rgba(15, 23, 42, 0.4);
                --border: rgba(255, 255, 255, 0.1);
                --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif; margin: 0; padding: 20px;
            min-height: 100vh; color: var(--text-main);
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #4338ca);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            overflow-x: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #snowCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.5; }

        /* --- LAYOUTS --- */
        .main-container { width: 100%; max-width: 500px; z-index: 2; position: relative; transition: all 0.3s ease; }
        
        /* TV Layout: Splits screen into Main + Sidebar */
        body.tv-active { align-items: flex-start; padding-top: 50px; zoom: 1.2; }
        body.tv-active .main-container { max-width: 900px; display: flex; gap: 20px; }
        body.tv-active .app-card { flex: 1.5; } /* Game takes more space */
        body.tv-active .sidebar { display: block; flex: 1; }

        /* Sidebar (Scoreboard) - Hidden on Mobile by default */
        .sidebar { display: none; background: var(--bg-card); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; height: fit-content; max-height: 80vh; overflow-y: auto; }

        .app-card {
            background: var(--bg-card); backdrop-filter: blur(12px);
            border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 2.5rem 2rem;
            width: 100%; position: relative;
        }

        /* --- COMMON UI --- */
        h1 { margin: 0 0 10px 0; color: var(--primary); font-weight: 900; text-align: center; font-size: 2.2rem; }
        h2 { margin: 0 0 15px 0; font-size: 1.6rem; text-align: center; font-weight: 800; }
        p { margin: 0 0 25px 0; color: var(--text-sub); text-align: center; line-height: 1.6; }
        .label { display: block; font-size: 0.8rem; font-weight: 800; color: var(--text-sub); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        .row { display: flex; gap: 12px; } .col { flex: 1; }
        input, select { width: 100%; padding: 16px; border: 2px solid transparent; border-radius: 16px; font-size: 1rem; font-weight: 700; background: var(--bg-item); color: var(--text-main); }
        input:focus, select:focus { outline: none; background: var(--bg-card); border-color: var(--primary); }

        button { width: 100%; padding: 16px; border: none; border-radius: 18px; font-size: 1rem; font-weight: 800; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: var(--bg-item); color: var(--text-main); border: 1px solid var(--border); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; width: auto; border-radius: 12px; }
        .btn-icon { width: 44px; padding: 0; font-size: 1.2rem; flex-shrink: 0; }

        .list-wrap { display: flex; flex-direction: column; gap: 12px; margin: 25px 0; max-height: 400px; overflow-y: auto; padding-right: 4px; }
        .item-card { background: var(--bg-item); padding: 14px 18px; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .item-card.correct { background: rgba(16, 185, 129, 0.15); border-color: var(--success); }
        .item-card.wrong { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); }
        .item-card.gold { background: rgba(245, 158, 11, 0.15); border-color: var(--gold); }
        
        .rank-badge { background: var(--text-main); color: var(--bg-card); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; margin-right: 12px; }
        .timer-badge { background: var(--text-main); color: var(--bg-card); padding: 6px 16px; border-radius: 50px; font-weight: 800; font-family: monospace; display: inline-block; margin-bottom: 15px; }

        /* Secret Box */
        .secret-container { position: relative; margin: 30px 0; cursor: pointer; height: 140px; display: flex; align-items: center; justify-content: center; background: var(--bg-item); border-radius: 24px; user-select: none; }
        .secret-blur { filter: blur(25px); opacity: 0.4; transition: all 0.3s ease; }
        .secret-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--text-main); color: var(--bg-card); padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 800; pointer-events: none; transition: opacity 0.2s; white-space: nowrap; }
        .secret-container.revealed .secret-blur { filter: blur(0); opacity: 1; transform: scale(1.1); }
        .secret-container.revealed .secret-overlay { opacity: 0; }
        .big-number { font-size: 5rem; font-weight: 900; color: var(--primary); line-height: 1; }

        /* Scoreboard Rows */
        .score-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-weight: 700; }
        .score-val { color: var(--primary); font-weight: 900; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; pointer-events: all; }
        .modal-content { background: var(--bg-card); padding: 30px; border-radius: 24px; text-align: center; width: 90%; max-width: 320px; transform: scale(0.9); transition: transform 0.3s; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        #qrDisplay { margin: 20px auto; display: flex; justify-content: center; background: white; padding: 15px; border-radius: 16px; width: fit-content; }
        .divider { height: 2px; background: var(--border); margin: 25px 0; border-radius: 2px; }
        .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--text-main); color: var(--bg-card); padding: 14px 28px; border-radius: 50px; font-weight: 700; font-size: 0.95rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; pointer-events: none; transition: all 0.4s; z-index: 1000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 10px; opacity: 0.2; }
        .btn-mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .mode-select-btn { height: 120px; font-size: 1.5rem; flex-direction: column; }
    </style>
</head>
<body>

    <canvas id="snowCanvas"></canvas>

    <div class="main-container">
        <!-- Main Game Card -->
        <div class="app-card" id="app">
            <!-- Content Injected via JS -->
        </div>

        <!-- Sidebar Scoreboard (TV Mode Only) -->
        <div class="sidebar" id="tvSidebar">
            <h2 style="margin-bottom:10px;">üèÜ Leaderboard</h2>
            <p style="font-size:0.8rem; margin-bottom:15px;">+10 pts for correct rank</p>
            <div id="sidebarScores"></div>
            <button class="btn-secondary btn-sm" style="margin-top:20px; width:100%;" onclick="resetScores()">Reset Points</button>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="qrModal" onclick="closeModal('qrModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="qrName" style="margin-bottom:5px;">Scan Me</h2>
            <p id="qrSub" style="font-size:0.8rem;"></p>
            <div id="qrDisplay"></div>
            <button class="btn-secondary" onclick="closeModal('qrModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="presetsModal" onclick="closeModal('presetsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üíæ Saved Groups</h2>
            <div id="presetsList" style="margin:20px 0; text-align:left;"></div>
            <button class="btn-secondary" onclick="closeModal('presetsModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal" onclick="closeModal('historyModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üìú Game History</h2>
            <div id="historyList" style="margin:20px 0; text-align:left;"></div>
            <button class="btn-secondary" onclick="closeModal('historyModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="scoreModal" onclick="closeModal('scoreModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üèÜ Scoreboard</h2>
            <div id="modalScores" style="margin:20px 0; text-align:left;"></div>
            <button class="btn-secondary" onclick="resetScores()">Reset Points</button>
            <br><br>
            <button class="btn-secondary" onclick="closeModal('scoreModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="dataModal" onclick="closeModal('dataModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>‚öôÔ∏è Data Manager</h2>
            <div class="btn-mini-grid">
                <button class="btn-secondary" onclick="exportData()">üì§ Export</button>
                <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">üì• Import</button>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
            <div class="divider"></div>
            <button class="btn-danger" onclick="wipeData()">üóëÔ∏è Factory Reset</button>
            <br><br>
            <button class="btn-secondary" onclick="closeModal('dataModal')">Close</button>
        </div>
    </div>
    
    <div id="toast" class="toast">Action</div>
    <div style="position:fixed; bottom:10px; right:10px; opacity:0.3; cursor:pointer; z-index:99; font-size:24px;" onclick="if(confirm('Hard Reset?')) { localStorage.clear(); location.reload(); }">üóëÔ∏è</div>

    <script>
        const GOD_PASSWORD = "1234";
        const DEFAULT_STATE = { 
            step: 'MODE_SELECT', // New Start Step
            players: [], 
            settings: { min: 1, max: 200, order: 'asc' }, 
            startTime: null, finalTime: null, passIndex: 0, viewingNumber: false,
            mode: null, // 'tv' or 'mobile'
            scores: {}
        };
        
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let timerInterval = null;
        let godMode = false;
        const app = document.getElementById('app');

        // --- UTILS ---
        function pulse(ms = 10) { if (navigator.vibrate) navigator.vibrate(ms); }
        async function requestWakeLock() { if ('wakeLock' in navigator) try { await navigator.wakeLock.request('screen'); } catch (e) {} }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        function formatTime(s) { if(s === null) return "0:00"; return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; }
        function encodeData(obj) { return btoa(JSON.stringify(obj)); }
        function decodeData(str) { try { return JSON.parse(atob(str)); } catch(e) { return null; } }

        // --- CORE RENDER ENGINE ---
        function setState(s) { state.step = s; saveState(); render(); }
        function render() {
            const params = new URLSearchParams(window.location.search);
            
            // Check for Lobby/Player Link (No Mode Select needed)
            if (params.get('p')) { renderPlayerView(params.get('p')); return; }
            if (params.get('lobby')) { renderLobby(params.get('lobby')); return; }

            // Mode Handling
            if (!state.mode) { renderModeSelect(); return; }
            
            // Apply TV Styling if needed
            if (state.mode === 'tv') {
                document.body.classList.add('tv-active');
                updateScoreDisplay('sidebarScores');
            } else {
                document.body.classList.remove('tv-active');
            }

            // Route Views
            if(state.step === 'MODE_SELECT') renderModeSelect();
            else if(state.step === 'SETUP') renderSetup();
            else if(state.step === 'DISTRIBUTE') renderDistribute();
            else if(state.step === 'PASS_PLAY') renderPassPlay();
            else if(state.step === 'VERIFY') renderVerify();
            else if(state.step === 'RESULTS') renderResults();
        }

        // --- VIEW 0: MODE SELECTION ---
        function renderModeSelect() {
            document.body.classList.remove('tv-active');
            app.innerHTML = `
                <h1>Welcome!</h1>
                <p>How are you hosting today?</p>
                <div class="btn-mini-grid" style="gap:20px;">
                    <button class="btn-secondary mode-select-btn" onclick="selectMode('mobile')">
                        üì±<br><span style="font-size:1rem">Mobile</span>
                    </button>
                    <button class="btn-secondary mode-select-btn" onclick="selectMode('tv')">
                        üì∫<br><span style="font-size:1rem">TV</span>
                    </button>
                </div>
            `;
        }

        function selectMode(m) {
            state.mode = m;
            state.step = 'SETUP';
            saveState();
            render();
        }

        // --- VIEW 1: SETUP ---
        function renderSetup() {
            app.innerHTML = `
                <h1>Line Up!</h1>
                <p>${state.mode === 'tv' ? 'TV Host Mode' : 'Mobile Host Mode'}</p>
                <div class="row">
                    <div class="col"><label class="label">Min</label><input type="number" id="minInput" value="${state.settings.min}"></div>
                    <div class="col"><label class="label">Max</label><input type="number" id="maxInput" value="${state.settings.max}"></div>
                </div>
                <div style="margin-top:15px;">
                    <label class="label">Sort Order</label>
                    <select id="orderInput">
                        <option value="asc" ${state.settings.order === 'asc' ? 'selected' : ''}>Smallest ‚Üí Biggest</option>
                        <option value="desc" ${state.settings.order === 'desc' ? 'selected' : ''}>Biggest ‚Üí Smallest</option>
                    </select>
                </div>
                <div class="divider"></div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="label" style="margin:0;">Players (${state.players.length})</label>
                    <div style="display:flex; gap:5px;">
                        ${state.mode === 'mobile' ? `<button class="btn-secondary btn-sm" onclick="openScoreModal()">üèÜ</button>` : ''}
                        <button class="btn-secondary btn-sm" onclick="openModal('presetsModal')">üíæ</button>
                        <button class="btn-secondary btn-sm" onclick="openModal('historyModal')">üìú</button>
                        <button class="btn-secondary btn-sm" onclick="openModal('dataModal')">‚öôÔ∏è</button>
                        <button class="btn-secondary btn-sm" onclick="savePreset()">+Save</button>
                    </div>
                </div>
                <div class="row" style="margin-top:10px; margin-bottom:15px;">
                    <input type="text" id="nameInput" placeholder="Name" onkeydown="if(event.key==='Enter') addPlayer()">
                    <button class="btn-primary" style="width:auto;" onclick="addPlayer()">Add</button>
                </div>
                <div class="list-wrap">
                    ${state.players.length === 0 ? '<div style="text-align:center; opacity:0.5; padding:20px;">Add players...</div>' : ''}
                    ${state.players.map((p, i) => `
                        <div class="item-card">
                            <span style="font-weight:700;">${p.name}</span>
                            <button class="btn-danger btn-icon" style="width:32px; height:32px; font-size:1rem;" onclick="removePlayer(${i})">‚úï</button>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-primary" onclick="startGame()" ${state.players.length < 2 ? 'disabled' : ''}>${state.players.length < 2 ? 'Add Players to Start' : 'Generate Numbers'}</button>
                <div style="text-align:center; margin: 12px 0; font-size: 0.8rem; font-weight:800; opacity:0.5; letter-spacing:1px;">‚Äî OR ‚Äî</div>
                <button class="btn-secondary" onclick="startPassGame()" ${state.players.length < 2 ? 'disabled' : ''}>üì± Pass & Play</button>
                <br>
                <button class="btn-secondary btn-sm" onclick="state.mode=null; render()">Change Mode</button>
            `;
        }

        // --- VIEW 2: DISTRIBUTE (Split Logic) ---
        function renderDistribute() {
            const baseUrl = window.location.href.split('?')[0];
            const currentSeconds = state.startTime ? Math.floor((Date.now() - state.startTime) / 1000) : 0;
            
            let content = `<div style="text-align:center;"><div id="timerDisplay" class="timer-badge">‚è±Ô∏è ${formatTime(currentSeconds)}</div></div><h2>üîó Distribute</h2>`;

            if (state.mode === 'tv') {
                // TV MODE: Show Master Lobby QR
                const payload = { all: state.players, min: state.settings.min, max: state.settings.max, o: state.settings.order };
                const lobbyLink = `${baseUrl}?lobby=${encodeData(payload)}`;
                
                content += `
                    <p>Scan to join Lobby</p>
                    <div style="background:white; padding:15px; border-radius:16px; margin:20px auto; width:fit-content;">
                        <div id="masterQr"></div>
                    </div>
                    <script>
                        new QRCode(document.getElementById("masterQr"), { text: "${lobbyLink}", width: 200, height: 200 });
                    <\/script>
                `;
            } else {
                // MOBILE MODE: Show Individual Buttons
                content += `<div class="list-wrap">
                    ${state.players.map((p, i) => {
                        const payload = { n: p.name, v: p.number, min: state.settings.min, max: state.settings.max, o: state.settings.order };
                        const link = `${baseUrl}?p=${encodeData(payload)}`;
                        return `
                        <div class="item-card">
                            <span style="font-weight:800;">${p.name}</span>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-secondary btn-sm" onclick="showQr('${link}', '${p.name}')">QR</button>
                                <button class="btn-secondary btn-sm" onclick="copyLink('${link}')">Copy</button>
                                <button class="btn-secondary btn-sm" onclick="shareLink('${link}', '${p.name}')">üì§</button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
            }

            content += `
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn-primary" onclick="setState('VERIFY')">Start Verification</button>
                    <button class="btn-secondary" style="margin-top:10px;" onclick="setState('SETUP')">Back</button>
                </div>
            `;
            
            app.innerHTML = content;
            if(state.mode === 'tv') {
                 // Re-init QR because innerHTML kills scripts
                 const payload = { all: state.players, min: state.settings.min, max: state.settings.max, o: state.settings.order };
                 const lobbyLink = `${baseUrl}?lobby=${encodeData(payload)}`;
                 new QRCode(document.getElementById("masterQr"), { text: lobbyLink, width: 200, height: 200 });
            }
            startTimerTicker();
        }

        // --- LOBBY LOGIC (For Players on Phones) ---
        function renderLobby(encodedData) {
            const data = decodeData(encodedData);
            if (!data) return app.innerHTML = `<h2>Error</h2><p>Invalid Game Code</p>`;
            
            if (data.all.length > 1) {
                // List Selection
                app.innerHTML = `
                    <h1>Who are you?</h1>
                    <div class="list-wrap">
                        ${data.all.map((p, i) => `
                            <button class="btn-secondary" style="margin-bottom:10px; justify-content:space-between;" onclick="selectLobbyPlayer('${encodedData}', ${i})">
                                ${p.name} <span>üëâ</span>
                            </button>
                        `).join('')}
                    </div>
                `;
            } else {
                // Reveal Screen
                const p = data.all[0];
                const orderText = data.o === 'asc' ? 'Smallest to Biggest' : 'Biggest to Smallest';
                app.innerHTML = `
                    <div style="text-align:center;"><h2>Hi, ${p.name}!</h2><p>Tap & hold.</p></div>
                    <div class="secret-container" id="secretBox"><div class="secret-overlay">HOLD</div><div class="big-number secret-blur">${p.number}</div></div>
                    <div style="background:var(--bg-item); padding:20px; border-radius:16px; text-align:left; font-size:0.95rem;">Range: <strong>${data.min} - ${data.max}</strong><br>Goal: <strong>${orderText}</strong></div>
                `;
                bindSecretBox();
            }
        }

        function selectLobbyPlayer(fullDataStr, index) {
            const data = decodeData(fullDataStr);
            const myPayload = { all:[data.all[index]], min:data.min, max:data.max, o:data.o };
            renderLobby(encodeData(myPayload));
        }

        // --- VIEW: RESULTS (With Scoring) ---
        function renderResults() {
            clearInterval(timerInterval);
            const sorted = [...state.players].sort((a, b) => state.settings.order === 'asc' ? a.number - b.number : b.number - a.number);
            let allCorrect = true;
            
            const roundProcessed = state.finalTime !== null;

            const listHtml = state.players.map((p, i) => {
                const isCorrect = p.name === sorted[i].name; 
                if (!isCorrect) allCorrect = false;
                const realRank = sorted.findIndex(x => x.name === p.name) + 1; 
                return `
                    <div class="item-card ${isCorrect ? 'correct' : 'wrong'}">
                        <div>
                            <div style="display:flex; align-items:center;">
                                <div class="rank-badge" style="background:${isCorrect ? 'var(--success)' : 'var(--danger)'}; color:white;">${i+1}</div>
                                <strong>${p.name}</strong>
                                ${isCorrect ? '<span style="margin-left:8px; font-size:0.7rem; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">+10 pts</span>' : ''}
                            </div>
                            <div style="font-size:0.85rem; margin-top:6px; margin-left:40px; opacity:0.8;">Number: <strong>${p.number}</strong>${!isCorrect ? `(Should be #${realRank})` : ''}</div>
                        </div>
                        <div style="font-size:1.5rem;">${isCorrect ? '‚úÖ' : '‚ùå'}</div>
                    </div>`;
            }).join('');

            // SCORING CALCULATION
            if (!roundProcessed) {
                state.finalTime = Math.floor((Date.now() - state.startTime) / 1000);
                // Update Scores
                state.players.forEach((p, i) => {
                    if (p.name === sorted[i].name) {
                        state.scores[p.name] = (state.scores[p.name] || 0) + 10;
                    } else {
                        // Ensure entry exists
                        if(!state.scores[p.name]) state.scores[p.name] = 0;
                    }
                });
                saveState();
                saveHistory(true); // Simplified history saving
                if(allCorrect) setTimeout(() => confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } }), 200);
            }

            app.innerHTML = `
                <div style="text-align:center;">
                   <div class="timer-badge" style="background:${allCorrect? 'var(--gold)' : 'var(--bg-item)'}; color:${allCorrect?'white':'var(--text-main)'}">Time: ${formatTime(state.finalTime)}</div>
                </div>
                <h1>${allCorrect ? 'üéâ Perfect!' : 'üò¨ Result'}</h1>
                <div class="list-wrap">${listHtml}</div>
                <button class="btn-primary" onclick="restartSamePlayers()">üîÑ Play Again</button>
                <button class="btn-secondary" style="margin-top:10px;" onclick="resetGameData()">New Game</button>
            `;
        }

        // --- SCOREBOARD ---
        function updateScoreDisplay(targetId) {
            const el = document.getElementById(targetId);
            if(!el) return;
            if(!state.scores || Object.keys(state.scores).length === 0) { el.innerHTML = "<div style='text-align:center;opacity:0.5'>No points yet</div>"; return; }
            const sorted = Object.entries(state.scores).sort((a,b) => b[1]-a[1]);
            el.innerHTML = sorted.map(([n, s], i) => `
                <div class="score-row">
                    <div><span style="opacity:0.6; margin-right:8px;">#${i+1}</span>${n}</div>
                    <div class="score-val">${s}</div>
                </div>
            `).join('');
        }
        function openScoreModal() { openModal('scoreModal'); updateScoreDisplay('modalScores'); }
        function resetScores() { if(confirm("Reset Leaderboard?")) { state.scores = {}; saveState(); updateScoreDisplay('sidebarScores'); updateScoreDisplay('modalScores'); } }

        // --- PRESETS (Updated with Min/Max) ---
        function savePreset() {
            if(state.players.length === 0) return showToast("No players");
            const name = prompt("Name this group:");
            if(name) {
                const presets = JSON.parse(localStorage.getItem('lineUpPresets')) || [];
                // Save names + Current Settings
                presets.push({ 
                    name, 
                    players: state.players.map(p => ({ name: p.name, number: 0 })),
                    settings: { min: state.settings.min, max: state.settings.max }
                });
                localStorage.setItem('lineUpPresets', JSON.stringify(presets));
                showToast("Group Saved!");
            }
        }
        function loadPreset(index) {
            const presets = JSON.parse(localStorage.getItem('lineUpPresets')) || [];
            const p = presets[index];
            if(p) {
                state.players = JSON.parse(JSON.stringify(p.players));
                // Load Settings if they exist (backward compatibility)
                if(p.settings) {
                    state.settings.min = p.settings.min;
                    state.settings.max = p.settings.max;
                }
                saveState(); closeModal('presetsModal'); render(); showToast("Loaded!");
            }
        }

        // --- EXPORT (Updated) ---
        function exportData() {
            const data = {
                presets: localStorage.getItem('lineUpPresets'),
                history: localStorage.getItem('lineUpHistory'),
                leaderboard: localStorage.getItem('lineUpLeaderboard'),
                state: localStorage.getItem('lineUpState') // Includes scores now
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = 'lineup-backup.json';
            a.click(); showToast("Exported");
        }

        // --- STANDARD FUNCTIONS (Unchanged logic, kept for stability) ---
        function addPlayer() { 
            const n = document.getElementById('nameInput').value.trim(); 
            if(!n) return; 
            state.players.push({name:n, number:0}); 
            if(state.scores[n] === undefined) state.scores[n] = 0; 
            document.getElementById('nameInput').value=''; 
            setState('SETUP'); setTimeout(() => document.getElementById('nameInput').focus(), 50); 
        }
        function removePlayer(i) { state.players.splice(i, 1); setState('SETUP'); }
        function generateNumbers() {
            const min = parseInt(document.getElementById('minInput') ? document.getElementById('minInput').value : state.settings.min);
            const max = parseInt(document.getElementById('maxInput') ? document.getElementById('maxInput').value : state.settings.max);
            if (min >= max) { showToast("Min must be < Max!"); return false; }
            state.settings.min = min; state.settings.max = max;
            if(document.getElementById('orderInput')) state.settings.order = document.getElementById('orderInput').value;
            const used = new Set();
            state.players.forEach(p => { let num; do { num = Math.floor(Math.random()*(max-min+1))+min; } while(used.has(num)); used.add(num); p.number = num; });
            return true;
        }
        function startGame() { if(generateNumbers()) { state.startTime = Date.now(); state.finalTime = null; setState('DISTRIBUTE'); pulse(); requestWakeLock(); } }
        function startPassGame() { if(generateNumbers()) { state.passIndex=0; state.viewingNumber=false; state.startTime=null; setState('PASS_PLAY'); pulse(); requestWakeLock(); } }
        function nextPassPlayer() { if(state.passIndex < state.players.length-1) { state.passIndex++; state.viewingNumber=false; saveState(); render(); } else { state.startTime=Date.now(); setState('VERIFY'); } pulse(); }
        function restartSamePlayers() { state.startTime = null; state.finalTime = null; startGame(); }
        function resetGameData() { state = JSON.parse(JSON.stringify(DEFAULT_STATE)); saveState(); render(); }
        
        function renderPassPlay() {
            const p = state.players[state.passIndex];
            if (!state.viewingNumber) {
                app.innerHTML = `<div style="text-align:center; margin-top:20px;"><h1>üì±</h1><h2>Pass to<br><span style="color:var(--primary); font-size:2.5rem;">${p.name}</span></h2><div class="divider"></div><button class="btn-primary" onclick="state.viewingNumber=true; saveState(); render()">I am ${p.name}</button></div>`;
            } else {
                app.innerHTML = `<div style="text-align:center;"><h2>Hi, ${p.name}!</h2><p>Tap & hold.</p></div><div class="secret-container" id="secretBox"><div class="secret-overlay">HOLD</div><div class="big-number secret-blur">${p.number}</div></div><button class="btn-primary" onclick="nextPassPlayer()">${state.passIndex < state.players.length-1 ? 'Next' : 'Line Up!'}</button>`;
                bindSecretBox();
            }
        }
        function renderVerify() {
            if(!state.startTime) state.startTime = Date.now();
            const sec = Math.floor((Date.now() - state.startTime)/1000);
            app.innerHTML = `<div style="text-align:center;"><div id="timerDisplay" class="timer-badge">‚è±Ô∏è ${formatTime(sec)}</div></div><div style="display:flex; justify-content:space-between;"><h2>üßê Verify</h2><button class="btn-secondary btn-icon" onclick="toggleGodMode()">${godMode?'üîì':'üîí'}</button></div><div class="list-wrap">${state.players.map((p,i)=>`<div class="item-card"><div style="display:flex; align-items:center;"><div class="rank-badge">${i+1}</div><span>${p.name}</span>${godMode?` (${p.number})`:''}</div><div style="display:flex; gap:8px;"><button class="btn-secondary btn-icon" onclick="movePlayer(${i},-1)">‚ñ≤</button><button class="btn-secondary btn-icon" onclick="movePlayer(${i},1)">‚ñº</button></div></div>`).join('')}</div><button class="btn-primary" onclick="checkOrder()">Results</button><button class="btn-secondary" style="margin-top:10px" onclick="setState('DISTRIBUTE')">Back</button>`;
            startTimerTicker();
        }
        
        function movePlayer(i,d) { const t=i+d; if(t<0||t>=state.players.length)return; [state.players[i],state.players[t]]=[state.players[t],state.players[i]]; renderVerify(); saveState(); pulse(); }
        function checkOrder() { setState('RESULTS'); pulse(50); }
        function toggleGodMode() { if(godMode) { godMode=false; render(); } else { if(prompt("Password:")===GOD_PASSWORD) { godMode=true; render(); } } }
        function bindSecretBox() { const b=document.getElementById('secretBox'); if(!b)return; const r=e=>{if(e.cancelable)e.preventDefault();b.classList.add('revealed');pulse(5)}; const h=e=>{if(e.cancelable)e.preventDefault();b.classList.remove('revealed')}; ['touchstart','mousedown'].forEach(e=>b.addEventListener(e,r,{passive:false})); ['touchend','mouseup','mouseleave'].forEach(e=>b.addEventListener(e,h)); }
        function copyLink(u) { navigator.clipboard.writeText(u); showToast("Copied"); pulse(); }
        async function shareLink(u,n) { if(navigator.share) try{await navigator.share({title:'Line Up!',text:n,url:u});}catch(e){} else copyLink(u); }
        function showQr(u,n) { openModal('qrModal'); document.getElementById('qrName').textContent=n; document.getElementById('qrSub').textContent=""; const c=document.getElementById('qrDisplay'); c.innerHTML=''; new QRCode(c,{text:u,width:200,height:200}); }
        function openModal(id) { document.getElementById(id).classList.add('active'); if(id==='presetsModal') renderPresetsList(); if(id==='historyModal') renderHistoryList(); pulse(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); pulse(); }
        function startTimerTicker() { if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { const el=document.getElementById('timerDisplay'); if(el&&state.startTime) el.innerText = `‚è±Ô∏è ${formatTime(Math.floor((Date.now()-state.startTime)/1000))}`; }, 1000); }
        function renderPresetsList() { const ps=JSON.parse(localStorage.getItem('lineUpPresets'))||[]; const el=document.getElementById('presetsList'); if(ps.length===0) { el.innerHTML="<p>No saves</p>"; return; } el.innerHTML=ps.map((p,i)=>`<div class="item-card"><div><strong>${p.name}</strong> (${p.players.length})</div><div><button class="btn-primary btn-sm" onclick="loadPreset(${i})">Load</button><button class="btn-danger btn-sm" onclick="deletePreset(${i})">X</button></div></div>`).join(''); }
        function deletePreset(i) { const ps=JSON.parse(localStorage.getItem('lineUpPresets'))||[]; ps.splice(i,1); localStorage.setItem('lineUpPresets',JSON.stringify(ps)); renderPresetsList(); }
        function renderHistoryList() { const log=JSON.parse(localStorage.getItem('lineUpHistory'))||[]; const el=document.getElementById('historyList'); if(log.length===0){el.innerHTML="<p>Empty</p>";return;} el.innerHTML=log.map(g=>`<div class="item-card" style="${g.win?'border-color:var(--success)':''}"><div><div style="font-size:0.8rem;opacity:0.7">${g.date}</div><strong>${g.players} P</strong></div><div style="text-align:right;"><b>${g.time}</b><div>${g.win?'‚úÖ':'‚ùå'}</div></div></div>`).join(''); }
        function saveHistory(win) { const log=JSON.parse(localStorage.getItem('lineUpHistory'))||[]; log.unshift({date:new Date().toLocaleDateString(), players:state.players.length, time:formatTime(state.finalTime), win:win}); if(log.length>20)log.pop(); localStorage.setItem('lineUpHistory',JSON.stringify(log)); }
        function importData(e) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{const d=JSON.parse(ev.target.result); if(d.presets)localStorage.setItem('lineUpPresets',d.presets); if(d.history)localStorage.setItem('lineUpHistory',d.history); if(d.state)localStorage.setItem('lineUpState',d.state); showToast("Restored!"); setTimeout(()=>location.reload(),1000); }catch(err){showToast("Error");} }; r.readAsText(f); }
        function wipeData() { if(confirm("Delete all?")) { localStorage.clear(); location.reload(); } }
        function renderPlayerView(d) { const data=decodeData(d); if(!data)return app.innerHTML="Error"; app.innerHTML=`<div style="text-align:center;"><h2>Hi, ${data.n}!</h2><p>Tap & hold.</p></div><div class="secret-container" id="secretBox"><div class="secret-overlay">HOLD</div><div class="big-number secret-blur">${data.v}</div></div>`; bindSecretBox(); }

        initSnow(); loadState(); render();
    </script>
</body>
</html>
