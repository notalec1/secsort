<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Line Up! Ultimate TV</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root{--primary:#6366f1;--primary-dark:#4f46e5;--success:#10b981;--danger:#ef4444;--gold:#f59e0b;--text-main:#1e293b;--text-sub:#64748b;--bg-card:rgba(255,255,255,0.95);--bg-item:rgba(255,255,255,0.6);--border:rgba(255,255,255,0.6);--shadow:0 8px 32px 0 rgba(31,38,135,0.15);--radius:24px}
        @media(prefers-color-scheme:dark){:root{--text-main:#f8fafc;--text-sub:#94a3b8;--bg-card:rgba(30,41,59,0.9);--bg-item:rgba(15,23,42,0.4);--border:rgba(255,255,255,0.1);--shadow:0 8px 32px 0 rgba(0,0,0,0.3)}}
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Nunito',sans-serif;margin:0;padding:10px;min-height:100vh;display:flex;justify-content:center;align-items:center;color:var(--text-main);background:linear-gradient(-45deg,#0f172a,#1e1b4b,#312e81,#4338ca);background-size:400% 400%;animation:gradientBG 15s ease infinite;overflow:hidden}
        @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        #snowCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:0.5}

        /* DEFAULT / MOBILE STYLES */
        .app-card{background:var(--bg-card);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);width:100%;max-width:500px;padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);position:relative;z-index:2;transition:all 0.3s ease;display:flex;flex-direction:column;max-height:95vh;overflow-y:auto}
        .split-container{display:flex;flex-direction:column;gap:20px}
        h1{margin:0 0 10px 0;color:var(--primary);font-weight:900;text-align:center;font-size:2rem;line-height:1.1}
        h2{margin:0 0 15px 0;font-size:1.5rem;text-align:center;font-weight:800}
        h3{margin:0 0 10px 0;font-size:1.1rem;font-weight:800;opacity:0.8;text-transform:uppercase;letter-spacing:1px}
        p{margin:0 0 20px 0;color:var(--text-sub);text-align:center;line-height:1.4}
        .label{display:block;font-size:0.8rem;font-weight:800;color:var(--text-sub);margin-bottom:6px;text-transform:uppercase}
        .row{display:flex;gap:10px} .col{flex:1}
        input,select,button{width:100%;padding:14px;border-radius:14px;font-size:1rem;font-weight:700;border:none;font-family:inherit}
        input,select{background:var(--bg-item);color:var(--text-main);border:2px solid transparent}
        input:focus,select:focus{outline:none;background:var(--bg-card);border-color:var(--primary)}
        button{cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:0.2s}
        button:active{transform:scale(0.96)}
        .btn-primary{background:var(--primary);color:white}
        .btn-secondary{background:var(--bg-item);color:var(--text-main);border:1px solid var(--border)}
        .btn-danger{background:rgba(239,68,68,0.1);color:var(--danger)}
        .btn-icon{width:40px;padding:0;flex-shrink:0}
        .chip-container{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:10px 0 20px}
        .chip-btn{background:var(--bg-item);border:1px solid var(--border);padding:8px 2px;border-radius:10px;font-size:0.8rem}
        .list-wrap{display:flex;flex-direction:column;gap:10px;margin:15px 0;overflow-y:auto;padding-right:4px}
        .item-card{background:var(--bg-item);padding:12px 16px;border-radius:14px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .item-card.correct{background:rgba(16,185,129,0.15);border-color:var(--success)}
        .item-card.wrong{background:rgba(239,68,68,0.15);border-color:var(--danger)}
        .rank-badge{background:var(--text-main);color:var(--bg-card);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:bold;margin-right:10px}
        
        /* TV MODE OVERRIDES - MAXIMIZED & OPTIMIZED */
        body.is-tv-mode .app-card {
            max-width:98vw; width:98vw; height:96vh; max-height:96vh;
            padding: 2vh; border-radius:30px;
            display:flex; flex-direction:column; overflow:hidden;
        }
        body.is-tv-mode .split-container {
            flex-direction:row; height:100%; gap:2vw; overflow:hidden;
        }
        body.is-tv-mode .left-panel {
            flex: 1; display:flex; flex-direction:column; 
            justify-content:center; height:100%; overflow-y:auto;
        }
        body.is-tv-mode .right-panel {
            flex: 1.6; display:flex; flex-direction:column; gap:2vh; height:100%; overflow:hidden;
        }
        
        /* TV Typography Scaling */
        body.is-tv-mode h1 { font-size: 6vh; margin-bottom:1vh; }
        body.is-tv-mode h2 { font-size: 4vh; margin-bottom:1.5vh; }
        body.is-tv-mode h3 { font-size: 2.5vh; margin-bottom:1vh; }
        body.is-tv-mode p { font-size: 2vh; margin-bottom: 2vh; }
        body.is-tv-mode .label { font-size: 1.5vh; margin-bottom: 0.5vh; }
        body.is-tv-mode input, body.is-tv-mode select { font-size: 2.2vh; padding: 1.5vh; border-radius: 1.5vh; }
        body.is-tv-mode button { font-size: 2.2vh; padding: 2vh; border-radius: 2vh; }
        body.is-tv-mode .btn-sm { font-size: 1.5vh; padding: 1vh; }
        
        /* TV List Optimization */
        body.is-tv-mode .game-status-panel {
            flex:2; background:rgba(0,0,0,0.03); border-radius:20px; padding:2vh;
            overflow:hidden; display:flex; flex-direction:column; border:2px solid var(--border);
        }
        body.is-tv-mode .leaderboard-panel {
            flex:1; background:rgba(245,158,11,0.1); border-radius:20px; padding:2vh;
            overflow:hidden; display:flex; flex-direction:column; border:2px solid var(--gold);
        }
        body.is-tv-mode .list-wrap {
            margin: 0; padding-right: 10px; flex:1; overflow-y:auto; gap: 1.5vh;
        }
        /* Chunky Cards for TV */
        body.is-tv-mode .item-card {
            padding: 1.8vh 2vh; border-radius: 1.5vh;
        }
        body.is-tv-mode .item-card strong, 
        body.is-tv-mode .item-card span { font-size: 2.2vh; }
        body.is-tv-mode .rank-badge { width: 4vh; height: 4vh; font-size: 2vh; margin-right: 1.5vh; }
        
        /* TV Specific Timer */
        body.is-tv-mode .timer-badge { font-size: 5vh; padding: 1vh 4vh; margin-bottom: 3vh; }
        
        /* QR & Misc */
        .qr-grid-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;padding:10px;overflow-y:auto;max-height:75vh}
        .qr-card{background:white;color:black;border-radius:16px;padding:15px;display:flex;flex-direction:column;align-items:center}
        .secret-container{position:relative;margin:30px 0;height:140px;display:flex;align-items:center;justify-content:center;background:var(--bg-item);border-radius:24px;user-select:none}
        .secret-blur{filter:blur(25px);opacity:0.4;transition:all 0.3s ease}
        .secret-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--text-main);color:var(--bg-card);padding:12px 24px;border-radius:50px;font-weight:800}
        .secret-container.revealed .secret-blur{filter:blur(0);opacity:1}
        .secret-container.revealed .secret-overlay{opacity:0}
        .big-number{font-size:5rem;font-weight:900;color:var(--primary)}
        
        /* Modals */
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:100;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:0.3s}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal-content{background:var(--bg-card);padding:30px;border-radius:24px;text-align:center;width:90%;max-width:320px;transform:scale(0.9);transition:0.3s;max-height:80vh;overflow-y:auto}
        .modal-overlay.active .modal-content{transform:scale(1)}
        .toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:var(--text-main);color:var(--bg-card);padding:14px 28px;border-radius:50px;font-weight:700;opacity:0;transition:0.4s;z-index:1000}
        .toast.show{opacity:1}
        .top-left-btn{position:absolute;top:15px;left:15px;z-index:10;font-size:1.5rem;background:none;border:none;cursor:pointer;opacity:0.4}
        .top-left-btn:hover{opacity:1}
        .mode-btn{height:15vh;flex-direction:column;font-size:1.5rem;gap:15px;background:var(--bg-item);border:2px solid var(--border)}
        .mode-btn:hover{background:var(--bg-card);border-color:var(--primary)}
        .mode-icon{font-size:3rem}
    </style>
</head>
<body>

    <canvas id="snowCanvas"></canvas>

    <div class="app-card" id="app">
        <div style="text-align:center;"><h1>Loading...</h1></div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="qrModal" onclick="closeModal('qrModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="qrName">Player</h2>
            <div id="qrDisplay" style="display:flex;justify-content:center;margin:20px;"></div>
            <button class="btn-secondary" onclick="closeModal('qrModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="leaderboardModal" onclick="closeModal('leaderboardModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üèÜ Leaderboard</h2>
            <div id="mobileLeaderboardList" style="margin:20px 0;text-align:left;max-height:300px;overflow-y:auto;"></div>
            <button class="btn-secondary" onclick="closeModal('leaderboardModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="qrGridModal" onclick="closeModal('qrGridModal')">
        <div class="modal-content" style="max-width:900px;width:95%;height:90vh;" onclick="event.stopPropagation()">
            <h2>Scan Names</h2>
            <div id="qrGridTarget" class="qr-grid-container"></div>
            <button class="btn-secondary" onclick="closeModal('qrGridModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="roomQrModal" onclick="closeModal('roomQrModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üè† Room Mode</h2>
            <div id="roomQrDisplay" style="margin:20px auto;background:white;padding:10px;border-radius:12px;width:fit-content;"></div>
            <button class="btn-secondary" onclick="closeModal('roomQrModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="presetsModal" onclick="closeModal('presetsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üíæ Groups</h2>
            <div id="presetsList" style="margin:20px 0;text-align:left;"></div>
            <button class="btn-secondary" onclick="closeModal('presetsModal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="dataModal" onclick="closeModal('dataModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>‚öôÔ∏è Data</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                <button class="btn-secondary" onclick="exportData()">Export</button>
                <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">Import</button>
            </div>
            <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
            <button class="btn-danger" style="margin-bottom:10px" onclick="resetScores()">Reset Scores</button>
            <button class="btn-danger" onclick="wipeData()">Factory Reset</button>
            <button class="btn-secondary" style="margin-top:20px" onclick="closeModal('dataModal')">Close</button>
        </div>
    </div>
    
    <div id="toast" class="toast">Action</div>

    <script>
        const GOD_PASSWORD = "line1up";
        const AUTO_NAMES = ["Alec", "Alain", "Nada", "Hoda", "Fadi", "Noa", "Gio", "Neo", "Nounou", "Assaad", "Chris", "Eliott"];
        const DEFAULT_STATE = { step: 'SETUP', players: [], settings: { min: 1, max: 100, order: 'asc' }, startTime: null, finalTime: null, passIndex: 0, viewingNumber: false };
        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let timerInterval = null, godMode = false;
        let viewMode = sessionStorage.getItem('lineUpViewMode') || null; 
        const app = document.getElementById('app');

        function pulse() { if (navigator.vibrate) navigator.vibrate(10); }
        async function requestWakeLock() { if ('wakeLock' in navigator) try { await navigator.wakeLock.request('screen'); } catch (err) {} }
        function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        function formatTime(s) { if(s===null)return"0:00"; return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function setViewMode(m) { viewMode=m; sessionStorage.setItem('lineUpViewMode',m); if(m==='tv')document.body.classList.add('is-tv-mode'); else document.body.classList.remove('is-tv-mode'); render(); }
        function resetViewMode() { viewMode=null; sessionStorage.removeItem('lineUpViewMode'); document.body.classList.remove('is-tv-mode'); render(); }

        function initSnow() {
            const canvas=document.getElementById('snowCanvas'), ctx=canvas.getContext('2d');
            let width=canvas.width=window.innerWidth, height=canvas.height=window.innerHeight;
            const snowflakes=[]; window.addEventListener('resize',()=>{width=canvas.width=window.innerWidth;height=canvas.height=window.innerHeight});
            for(let i=0;i<50;i++) snowflakes.push({x:Math.random()*width,y:Math.random()*height,r:Math.random()*3+1,d:Math.random()*50});
            function draw() { ctx.clearRect(0,0,width,height); ctx.fillStyle="rgba(255,255,255,0.4)"; ctx.beginPath();
                for(let i=0;i<50;i++){const f=snowflakes[i];ctx.moveTo(f.x,f.y);ctx.arc(f.x,f.y,f.r,0,Math.PI*2,true)}
                ctx.fill(); update(); requestAnimationFrame(draw); }
            function update() { for(let i=0;i<50;i++){const f=snowflakes[i];f.y+=Math.pow(f.d,2)+1;if(f.y>height)f.y=0;f.x+=Math.sin(f.y/50)} }
            draw();
        }

        function loadState() {
            if(new URLSearchParams(window.location.search).has('p')||new URLSearchParams(window.location.search).has('room')) return;
            try{const s=localStorage.getItem('lineUpState');if(s){state=JSON.parse(s);if((state.step==='DISTRIBUTE'||state.step==='VERIFY')&&state.startTime)startTimerTicker()}}catch(e){state=JSON.parse(JSON.stringify(DEFAULT_STATE))}
        }
        function saveState() { if(!new URLSearchParams(window.location.search).has('p'))localStorage.setItem('lineUpState',JSON.stringify(state)); }
        function getLeaderboard() { try{return JSON.parse(localStorage.getItem('lineUpLeaderboard'))||{}}catch(e){return{}} }
        function updateScores() {
            const sorted=[...state.players].sort((a,b)=>state.settings.order==='asc'?a.number-b.number:b.number-a.number);
            const scores=getLeaderboard(); let changed=false;
            state.players.forEach((p,i)=>{ if(p.name===sorted[i].name){scores[p.name]=(scores[p.name]||0)+10;changed=true}else{scores[p.name]=scores[p.name]||0} });
            if(changed)localStorage.setItem('lineUpLeaderboard',JSON.stringify(scores));
            return scores;
        }
        function resetScores() { if(confirm("Reset scores?")){localStorage.removeItem('lineUpLeaderboard');showToast("Scores Reset");render()} }
        function exportData() {
            const d={presets:localStorage.getItem('lineUpPresets'),history:localStorage.getItem('lineUpHistory'),state:localStorage.getItem('lineUpState'),leaderboard:localStorage.getItem('lineUpLeaderboard')};
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'})); a.download='lineup-backup.json'; a.click();
        }
        function importData(e) {
            const f=e.target.files[0]; if(!f)return; const r=new FileReader();
            r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);if(d.presets)localStorage.setItem('lineUpPresets',d.presets);if(d.history)localStorage.setItem('lineUpHistory',d.history);if(d.leaderboard)localStorage.setItem('lineUpLeaderboard',d.leaderboard);showToast("Restored!");setTimeout(()=>location.reload(),1000)}catch(err){showToast("Invalid")}};
            r.readAsText(f);
        }
        function wipeData() { if(confirm("Hard Reset?")){localStorage.clear();location.reload()} }

        function addPlayer(optionalName) {
            const input=document.getElementById('nameInput'); const name=optionalName||input.value.trim();
            if(!name)return;
            if(state.players.some(p=>p.name.toLowerCase()===name.toLowerCase()))return showToast("Duplicate!");
            state.players.push({name,number:0}); if(input)input.value=''; setState('SETUP'); if(!optionalName)setTimeout(()=>document.getElementById('nameInput')?.focus(),50);
        }
        function removePlayer(i) { state.players.splice(i,1); setState('SETUP'); }
        function generateNumbers() {
            const min=parseInt(document.getElementById('minInput')?.value||state.settings.min);
            const max=parseInt(document.getElementById('maxInput')?.value||state.settings.max);
            if(min>=max){showToast("Min must be < Max");return false}
            state.settings.min=min; state.settings.max=max; state.settings.order=document.getElementById('orderInput')?.value||state.settings.order;
            const used=new Set();
            state.players.forEach(p=>{let n;do{n=Math.floor(Math.random()*(max-min+1))+min}while(used.has(n));used.add(n);p.number=n});
            return true;
        }
        function startGame() { if(generateNumbers()){state.startTime=Date.now();state.finalTime=null;setState('DISTRIBUTE');requestWakeLock()} }
        function startPassGame() { if(state.players.length<2)return showToast("Need 2+"); if(generateNumbers()){state.passIndex=0;state.viewingNumber=false;state.startTime=null;setState('PASS_PLAY');requestWakeLock()} }
        function nextPassPlayer() { if(state.passIndex<state.players.length-1){state.passIndex++;state.viewingNumber=false;saveState();render()}else{state.startTime=Date.now();setState('VERIFY')} }
        function restartSamePlayers() { state.startTime=null;state.finalTime=null;startGame() }
        function resetGameData() { state=JSON.parse(JSON.stringify(DEFAULT_STATE)); saveState(); render(); }
        
        function savePreset() {
            if(!state.players.length)return; const name=prompt("Group Name:"); if(!name)return;
            const p=JSON.parse(localStorage.getItem('lineUpPresets'))||[];
            p.push({name,players:state.players.map(x=>({name:x.name,number:0})),min:state.settings.min,max:state.settings.max});
            localStorage.setItem('lineUpPresets',JSON.stringify(p)); showToast("Saved");
        }
        function loadPreset(i) {
            const p=JSON.parse(localStorage.getItem('lineUpPresets'))||[]; if(!p[i])return;
            state.players=JSON.parse(JSON.stringify(p[i].players)); state.settings.min=p[i].min||1; state.settings.max=p[i].max||100;
            saveState(); closeModal('presetsModal'); render();
        }
        function deletePreset(i) { const p=JSON.parse(localStorage.getItem('lineUpPresets'))||[]; p.splice(i,1); localStorage.setItem('lineUpPresets',JSON.stringify(p)); renderPresetsList(); }
        function renderPresetsList() {
            const p=JSON.parse(localStorage.getItem('lineUpPresets'))||[]; const el=document.getElementById('presetsList');
            el.innerHTML=p.length?p.map((x,i)=>`<div class="item-card" style="margin-bottom:5px"><div><strong>${x.name}</strong> (${x.players.length})</div><div><button class="btn-primary btn-sm" onclick="loadPreset(${i})">Load</button><button class="btn-danger btn-sm" style="margin-left:5px" onclick="deletePreset(${i})">X</button></div></div>`).join(''):"<p>Empty</p>";
        }

        function toggleGodMode() { if(godMode){godMode=false;render()}else{if(prompt("Pass:")===GOD_PASSWORD){godMode=true;render()}} }
        function startTimerTicker() {
            if(timerInterval)clearInterval(timerInterval);
            timerInterval=setInterval(()=>{
                const el=document.getElementById('timerDisplay');
                if(el&&state.startTime) el.innerText=`‚è±Ô∏è ${formatTime(Math.floor((Date.now()-state.startTime)/1000))}`;
            },1000);
        }
        function openModal(id){document.getElementById(id).classList.add('active');if(id==='presetsModal')renderPresetsList();if(id==='leaderboardModal')document.getElementById('mobileLeaderboardList').innerHTML=getLeaderboardHtml()}
        function closeModal(id){document.getElementById(id).classList.remove('active')}
        function setState(s){state.step=s;saveState();render()}

        function getLeaderboardHtml() {
            const s=Object.entries(getLeaderboard()).sort((a,b)=>b[1]-a[1]);
            if(!s.length)return `<div style="text-align:center;opacity:0.6;font-size:1.5vh">No scores yet</div>`;
            return s.map((e,i)=>`<div class="item-card" style="padding:1vh 2vh;margin-bottom:1vh;border:none;background:rgba(255,255,255,0.5);"><div style="display:flex;align-items:center;"><span style="font-weight:900;width:30px;opacity:0.6;">${i+1}</span><span style="font-weight:700;">${e[0]}</span></div><strong style="color:var(--primary-dark)">${e[1]}</strong></div>`).join('');
        }

        function renderModeSelection() {
            app.innerHTML=`<h1>Display Mode</h1><div class="row" style="margin-top:20px"><button class="mode-btn col" onclick="setViewMode('mobile')"><div class="mode-icon">üì±</div>Mobile</button><button class="mode-btn col" onclick="setViewMode('tv')"><div class="mode-icon">üì∫</div>TV</button></div>`;
        }

        function renderSetup() {
            const sw=`<button class="top-left-btn" onclick="resetViewMode()">‚ÜîÔ∏è</button>`;
            const left=`
                <h1>Line Up!</h1>
                <div class="row">
                    <div class="col"><label class="label">Min</label><input type="number" id="minInput" value="${state.settings.min}"></div>
                    <div class="col"><label class="label">Max</label><input type="number" id="maxInput" value="${state.settings.max}"></div>
                </div>
                <div style="margin-top:1.5vh"><label class="label">Sort</label><select id="orderInput"><option value="asc" ${state.settings.order==='asc'?'selected':''}>Smallest ‚Üí Biggest</option><option value="desc" ${state.settings.order==='desc'?'selected':''}>Biggest ‚Üí Smallest</option></select></div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:2vh">
                    <label class="label" style="margin:0">Players (${state.players.length})</label>
                    <div style="display:flex;gap:5px">
                        <button class="btn-secondary btn-sm" onclick="openModal('presetsModal')">üíæ</button>
                        <button class="btn-secondary btn-sm" onclick="savePreset()">+Save</button>
                        <button class="btn-secondary btn-sm" onclick="openModal('dataModal')">‚öôÔ∏è</button>
                    </div>
                </div>
                <div class="row" style="margin:1vh 0"><input type="text" id="nameInput" placeholder="Name" onkeydown="if(event.key==='Enter')addPlayer()"><button class="btn-primary" style="width:auto" onclick="addPlayer()">Add</button></div>
                <div class="chip-container">${AUTO_NAMES.map(n=>`<button class="chip-btn" onclick="addPlayer('${n}')">${n}</button>`).join('')}</div>
                <div style="margin-top:auto"><button class="btn-primary" onclick="startGame()" ${state.players.length<2?'disabled':''}>Generate Links</button></div>`;

            const roster=`<div class="list-wrap">${state.players.map((p,i)=>`<div class="item-card"><span style="font-weight:700;">${p.name}</span><button class="btn-danger btn-icon" onclick="removePlayer(${i})">‚úï</button></div>`).join('')}</div>`;
            
            if(viewMode==='tv') {
                app.innerHTML=`${sw}<div class="split-container"><div class="left-panel">${left}</div><div class="right-panel"><div class="game-status-panel"><h3>Roster</h3>${roster}</div><div class="leaderboard-panel"><h3>üèÜ Leaders</h3>${getLeaderboardHtml()}</div></div></div>`;
            } else {
                app.innerHTML=`${sw}${left}<div style="margin-top:10px">${roster}</div>`;
            }
        }

        function renderDistribute() {
            const sw=`<button class="top-left-btn" onclick="resetViewMode()">‚ÜîÔ∏è</button>`;
            const timer=`<div style="text-align:center"><div id="timerDisplay" class="timer-badge">‚è±Ô∏è ${formatTime(state.startTime?Math.floor((Date.now()-state.startTime)/1000):0)}</div></div>`;
            const controls=`${timer}<h2>üîó Distribute</h2><div style="text-align:center;margin-top:2vh"><button class="btn-primary" onclick="setState('VERIFY')">Verify</button><button class="btn-secondary" style="margin-top:10px" onclick="setState('SETUP')">Back</button></div><div class="row" style="margin-top:2vh"><button class="btn-secondary" onclick="openRoomQr()">üè† Room</button>${viewMode==='tv'?`<button class="btn-secondary" onclick="openQrGrid()">üì∫ Grid</button>`:''}</div>`;
            
            const list=`<div class="list-wrap">${state.players.map(p=>{
                const lnk=`${window.location.href.split('?')[0]}?p=${btoa(JSON.stringify({n:p.name,v:p.number,min:state.settings.min,max:state.settings.max,o:state.settings.order}))}`;
                return `<div class="item-card" style="flex-direction:column;gap:5px"><div style="display:flex;justify-content:space-between;width:100%"><span style="font-weight:800">${p.name}</span><span style="font-size:0.8em;background:var(--primary);color:white;padding:2px 8px;border-radius:8px">???</span></div><div class="row" style="width:100%"><button class="btn-secondary btn-icon" onclick="showQr('${lnk}','${p.name}')">üèÅ</button><button class="btn-secondary btn-sm" style="flex:1" onclick="copyLink('${lnk}')">Copy</button></div></div>`
            }).join('')}</div>`;

            if(viewMode==='tv') app.innerHTML=`${sw}<div class="split-container"><div class="left-panel">${controls}</div><div class="right-panel"><div class="game-status-panel"><h3>Links</h3>${list}</div><div class="leaderboard-panel"><h3>üèÜ Leaders</h3>${getLeaderboardHtml()}</div></div></div>`;
            else app.innerHTML=`${sw}${controls}${list}`;
            startTimerTicker();
        }

        function renderVerify() {
            if(!state.startTime)state.startTime=Date.now();
            const sw=`<button class="top-left-btn" onclick="resetViewMode()">‚ÜîÔ∏è</button>`;
            const timer=`<div style="text-align:center"><div id="timerDisplay" class="timer-badge">‚è±Ô∏è ${formatTime(Math.floor((Date.now()-state.startTime)/1000))}</div></div>`;
            const controls=`${timer}<div style="display:flex;justify-content:space-between"><h2>üßê Verify</h2><button class="btn-secondary btn-icon" onclick="toggleGodMode()">${godMode?'üîì':'üîí'}</button></div>${viewMode==='tv'?`<div style="margin-top:auto"><button class="btn-primary" style="background:var(--success);margin-bottom:1vh" onclick="checkOrder()">Reveal</button><button class="btn-secondary" onclick="setState('DISTRIBUTE')">Back</button></div>`:''}`;

            const list=`<div class="list-wrap">${state.players.map((p,i)=>`<div class="item-card"><div style="display:flex;align-items:center"><div class="rank-badge">${i+1}</div><div><span style="font-weight:700">${p.name}</span>${godMode?` (${p.number})`:''}</div></div><div style="display:flex;gap:5px"><button class="btn-secondary btn-icon" onclick="movePlayer(${i},-1)" ${i===0?'disabled':''}>‚ñ≤</button><button class="btn-secondary btn-icon" onclick="movePlayer(${i},1)" ${i===state.players.length-1?'disabled':''}>‚ñº</button></div></div>`).join('')}</div>`;

            if(viewMode==='tv') app.innerHTML=`${sw}<div class="split-container"><div class="left-panel">${controls}</div><div class="right-panel"><div class="game-status-panel"><h3>Order</h3>${list}</div><div class="leaderboard-panel"><h3>üèÜ Leaders</h3>${getLeaderboardHtml()}</div></div></div>`;
            else app.innerHTML=`${sw}${controls}${list}<button class="btn-primary" style="background:var(--success);margin-top:10px" onclick="checkOrder()">Reveal</button>`;
            startTimerTicker();
        }

        function renderResults() {
            clearInterval(timerInterval);
            const sorted=[...state.players].sort((a,b)=>state.settings.order==='asc'?a.number-b.number:b.number-a.number);
            let allCorrect=true;
            const list=state.players.map((p,i)=>{
                const ok=p.name===sorted[i].name; if(!ok)allCorrect=false;
                return `<div class="item-card ${ok?'correct':'wrong'}"><div><div style="display:flex;align-items:center"><div class="rank-badge" style="background:${ok?'var(--success)':'var(--danger)'}">${i+1}</div><strong>${p.name}</strong></div><div style="margin-top:5px;opacity:0.8;font-size:0.9em">Val: <strong>${p.number}</strong></div></div><div style="font-size:1.5em">${ok?'‚úÖ':'‚ùå'}</div></div>`;
            }).join('');
            
            if(!state.finalTime){ state.finalTime=Math.floor((Date.now()-state.startTime)/1000); updateScores(); if(allCorrect)confetti(); }
            
            const sw=`<button class="top-left-btn" onclick="resetViewMode()">‚ÜîÔ∏è</button>`;
            const head=`<div style="text-align:center"><div class="timer-badge" style="background:var(--gold)">Time: ${formatTime(state.finalTime)}</div><h1>${allCorrect?'üéâ Perfect!':'üò¨ Close!'}</h1></div>`;
            const btns=`<button class="btn-primary" onclick="restartSamePlayers()">üîÑ Play Again</button><button class="btn-secondary" style="margin-top:10px" onclick="resetGameData()">New Game</button>`;
            
            if(viewMode==='tv') app.innerHTML=`${sw}<div class="split-container"><div class="left-panel" style="justify-content:center">${head}<div style="margin-top:4vh">${btns}</div></div><div class="right-panel"><div class="game-status-panel"><h3>Results</h3><div class="list-wrap">${list}</div></div><div class="leaderboard-panel"><h3>üèÜ Leaders</h3>${getLeaderboardHtml()}</div></div></div>`;
            else app.innerHTML=`${sw}${head}<div class="list-wrap">${list}</div>${btns}`;
        }
        
        function renderPassPlay(){
            const p=state.players[state.passIndex];
            if(!state.viewingNumber) app.innerHTML=`<button class="top-left-btn" onclick="resetViewMode()">‚ÜîÔ∏è</button><div style="text-align:center;margin-top:20px"><h1 style="font-size:4rem">üì±</h1><h2>Pass to<br><span style="color:var(--primary)">${p.name}</span></h2><button class="btn-primary" style="margin-top:20px" onclick="state.viewingNumber=true;saveState();render()">I am ${p.name}</button></div>`;
            else {
                app.innerHTML=`<button class="top-left-btn" onclick="resetViewMode()">‚ÜîÔ∏è</button><div style="text-align:center"><h2>Hi ${p.name}</h2><p>Hold to see</p></div><div class="secret-container" id="secretBox"><div class="secret-overlay">HOLD</div><div class="big-number secret-blur">${p.number}</div></div><div style="background:var(--bg-item);padding:15px;border-radius:16px;margin-bottom:20px">Range: <strong>${state.settings.min} - ${state.settings.max}</strong></div><button class="btn-primary" onclick="nextPassPlayer()">${state.passIndex<state.players.length-1?'Next':'Done'}</button>`;
                bindSecretBox();
            }
        }
        
        function renderPlayerView(d){
            let data;try{data=JSON.parse(atob(d))}catch(e){}
            if(!data)return app.innerHTML=`<h2>Error</h2>`;
            app.innerHTML=`<div style="text-align:center"><h2>Hi ${data.n}</h2><p>Hold to see</p></div><div class="secret-container" id="secretBox"><div class="secret-overlay">HOLD</div><div class="big-number secret-blur">${data.v}</div></div><div style="background:var(--bg-item);padding:20px;border-radius:16px">Range: <strong>${data.min} - ${data.max}</strong></div>`;
            bindSecretBox();
        }
        function renderRoomView(d){
             let data;try{data=JSON.parse(atob(d))}catch(e){}
             app.innerHTML=`<h2>Pick Name</h2><div class="list-wrap">${data.players.map(p=>`<button class="btn-secondary" style="justify-content:space-between;padding:20px" onclick="window.location.search='?p='+btoa(JSON.stringify({n:'${p.n}',v:${p.v},min:${data.min},max:${data.max},o:'${data.o}'}))"><b>${p.n}</b><span>üëâ</span></button>`).join('')}</div>`;
        }

        function bindSecretBox() {
            const b=document.getElementById('secretBox');if(!b)return;
            const s=()=>{b.classList.add('revealed');pulse(5)}, h=()=>{b.classList.remove('revealed')};
            ['touchstart','mousedown'].forEach(e=>b.addEventListener(e,s)); ['touchend','mouseup','mouseleave'].forEach(e=>b.addEventListener(e,h));
        }
        function movePlayer(i,d){const t=i+d;if(t<0||t>=state.players.length)return;[state.players[i],state.players[t]]=[state.players[t],state.players[i]];renderVerify();saveState();pulse()}
        function copyLink(u){navigator.clipboard.writeText(u);showToast("Copied")}
        function showQr(u,n){openModal('qrModal');document.getElementById('qrName').textContent=n;const c=document.getElementById('qrDisplay');c.innerHTML='';new QRCode(c,{text:u,width:200,height:200})}
        function checkOrder(){setState('RESULTS');pulse(50)}
        function openQrGrid(){openModal('qrGridModal');const t=document.getElementById('qrGridTarget');t.innerHTML='';state.players.forEach(p=>{const d=document.createElement('div');d.className='qr-card';d.innerHTML=`<strong>${p.name}</strong><div id="q-${p.name}"></div>`;t.appendChild(d);new QRCode(document.getElementById(`q-${p.name}`),{text:window.location.href.split('?')[0]+'?p='+btoa(JSON.stringify({n:p.name,v:p.number,min:state.settings.min,max:state.settings.max,o:state.settings.order})),width:128,height:128})})}
        function openRoomQr(){openModal('roomQrModal');const c=document.getElementById('roomQrDisplay');c.innerHTML='';new QRCode(c,{text:window.location.href.split('?')[0]+'?room='+btoa(JSON.stringify({players:state.players.map(p=>({n:p.name,v:p.number})),min:state.settings.min,max:state.settings.max,o:state.settings.order})),width:250,height:250})}

        function render() {
            const p=new URLSearchParams(window.location.search);
            if(p.get('p'))return renderPlayerView(p.get('p'));
            if(p.get('room'))return renderRoomView(p.get('room'));
            if(!viewMode)return renderModeSelection();
            if(state.step==='SETUP')renderSetup();
            else if(state.step==='DISTRIBUTE')renderDistribute();
            else if(state.step==='PASS_PLAY')renderPassPlay();
            else if(state.step==='VERIFY')renderVerify();
            else if(state.step==='RESULTS')renderResults();
        }

        initSnow(); loadState();
        if(state.step!=='SETUP'&&!viewMode)viewMode='mobile';
        if(viewMode==='tv')document.body.classList.add('is-tv-mode');
        render();
    </script>
</body>
</html>